import{r as u,aZ as F,K as V,cl as R,u as B,a_ as Q,cp as H,j as q,b as P}from"./sanity-BixSMB_v.js";import{b as J,u as X,a as Y}from"./utils-C3oyw5At.js";import{c as Z,a as z,g as N}from"./PresentationToolGrantsCheck-22JQXROM.js";import{i as x}from"./DisplayedDocumentBroadcaster-BoDdbX7M.js";function ae(f){const{liveDocument:e,controller:l,perspective:b,onLoadersConnection:r,onDocumentsOnPage:i}=f,[d,C]=u.useState(),[h,A]=u.useState({}),E=F(),T=V();u.useEffect(()=>{const s=setInterval(()=>A(t=>{if(Object.keys(t).length<1)return t;const g=Date.now();if(!Object.values(t).some(a=>a.heartbeat!==!1&&g>a.receivedAt+a.heartbeat))return t;const c={};for(const[a,m]of Object.entries(t))m.heartbeat!==!1&&g>m.receivedAt+m.heartbeat||(c[a]=m);return c}),R);return()=>clearInterval(s)},[]),u.useEffect(()=>{if(l){const s=l.createChannel({name:"presentation",connectTo:"loaders",heartbeat:!0},Z().provide({actors:z()}));return C(s),s.onStatus(r),s.on("loader/documents",t=>{t.projectId===E&&t.dataset===T&&i("loaders",t.perspective,t.documents)}),s.on("loader/query-listen",t=>{if(t.projectId===E&&t.dataset===T){if(typeof t.heartbeat=="number"&&t.heartbeat<R)throw new Error(`Loader query listen heartbeat interval must be at least ${R}ms`);A(g=>({...g,[_(t.query,t.params)]:{perspective:t.perspective,query:t.query,params:t.params,receivedAt:Date.now(),heartbeat:t.heartbeat??!1}}))}}),s.start()}},[l,T,i,r,E]);const[I]=u.useState(()=>new Set),[w,o]=u.useState(null),p=B({apiVersion:"2023-10-16"}),y=u.useMemo(()=>p.config(),[p]),S=u.useMemo(()=>p.withConfig({resultSourceMap:"withKeyArraySelector"}),[p]);u.useEffect(()=>{if(d){const{projectId:s,dataset:t}=y;d.post("loader/perspective",{projectId:s,dataset:t,perspective:b})}},[d,y,b]);const j=Q(s=>{const t=Array.from(I).flat();s.tags.some(g=>t.includes(g))?o(s.id):console.log("No matching tags found",s.tags,{flattenedSyncTags:t})});u.useEffect(()=>{const s=H(S.config()).withConfig({apiVersion:"vX"}).live.events({includeDrafts:!0,tag:"presentation-loader"}).subscribe({next:t=>{t.type==="message"?j(t):t.type==="restart"?o(t.id):t.type==="reconnect"&&o(null)},error:t=>console.error("Error validating EventSource URL:",t)});return()=>s.unsubscribe()},[S,j]);const M=u.useDeferredValue(e);return q.jsx(q.Fragment,{children:Object.entries(h).map(([s,{query:t,params:g,perspective:c}])=>q.jsx(U,{projectId:y.projectId,dataset:y.dataset,perspective:c,query:t,params:g,comlink:d,client:S,liveDocument:M,lastLiveEventId:w,syncTagsInUse:I},`${s}${c}`))})}function G(f){const e=P.c(14),{projectId:l,dataset:b,perspective:r,query:i,client:d,liveDocument:C,comlink:h,lastLiveEventId:A,syncTagsInUse:E}=f,T=X(f.params),{result:I,resultSourceMap:w,syncTags:o}=W({client:d,liveDocument:C,params:T,perspective:r,query:i,lastLiveEventId:A})||{};let p;e[0]!==b||e[1]!==l?(p=(M,s,t,g,c,a,m)=>{M==null||M.post("loader/query-change",{projectId:l,dataset:b,perspective:s,query:t,params:g,result:c,resultSourceMap:a,tags:m})},e[0]=b,e[1]=l,e[2]=p):p=e[2];const y=Q(p);let S,j;return e[3]!==h||e[4]!==y||e[5]!==T||e[6]!==r||e[7]!==i||e[8]!==I||e[9]!==w||e[10]!==E||e[11]!==o?(S=()=>{if(w&&y(h,r,i,T,I,w,o),Array.isArray(o))return E.add(o),()=>{E.delete(o)}},j=[h,y,T,r,i,I,w,E,o],e[3]=h,e[4]=y,e[5]=T,e[6]=r,e[7]=i,e[8]=I,e[9]=w,e[10]=E,e[11]=o,e[12]=S,e[13]=j):(S=e[12],j=e[13]),u.useEffect(S,j),null}const U=u.memo(G);U.displayName="Memo(QuerySubscription)";function W(f){const e=P.c(25),{liveDocument:l,client:b,query:r,params:i,perspective:d,lastLiveEventId:C}=f,[h,A]=u.useState(null),[E,T]=u.useState(null);if(E)throw E;let I;e[0]===Symbol.for("react.memo_cache_sentinel")?(I={refreshInterval:0},e[0]=I):I=e[0];const[w,o]=Y(I),p=w==="refresh"||w==="inflight"||C!==(h==null?void 0:h.lastLiveEventId);let y,S;e[1]!==b||e[2]!==C||e[3]!==i||e[4]!==d||e[5]!==r||e[6]!==p||e[7]!==o?(y=()=>{if(!p)return;let c;c=!1;let a;a=!1;const m=new AbortController,k=async function(){const{signal:L}=m;a=!0;const{result:$,resultSourceMap:O,syncTags:D}=await b.fetch(r,i,{lastLiveEventId:C,tag:"presentation-loader",signal:L,perspective:d,filterResponse:!1,returnQuery:!1});a=!1,L.aborted||(A(n=>({result:x(n==null?void 0:n.result,$)?n==null?void 0:n.result:$,resultSourceMap:x(n==null?void 0:n.resultSourceMap,O)?n==null?void 0:n.resultSourceMap:O,syncTags:x(n==null?void 0:n.syncTags,D)?n==null?void 0:n.syncTags:D,lastLiveEventId:C})),c=!0)},K=o();return k().catch(L=>{a=!1,L.name!=="AbortError"&&T(L)}).finally(K),()=>{!c&&!a&&m.abort()}},S=[b,C,i,d,r,p,o],e[1]=b,e[2]=C,e[3]=i,e[4]=d,e[5]=r,e[6]=p,e[7]=o,e[8]=y,e[9]=S):(y=e[8],S=e[9]),u.useEffect(y,S);let j;e[10]!==h?(j=h??{},e[10]=h,e[11]=j):j=e[11];const{result:M,resultSourceMap:s,syncTags:t}=j;let g;e:{if(l&&s){let a;e[12]!==l||e[13]!==d||e[14]!==s||e[15]!==M?(a=v(l,M,d,s),e[12]=l,e[13]=d,e[14]=s,e[15]=M,e[16]=a):a=e[16];let m;e[17]!==s||e[18]!==t||e[19]!==a?(m={result:a,resultSourceMap:s,syncTags:t},e[17]=s,e[18]=t,e[19]=a,e[20]=m):m=e[20],g=m;break e}let c;e[21]!==s||e[22]!==M||e[23]!==t?(c={result:M,resultSourceMap:s,syncTags:t},e[21]=s,e[22]=M,e[23]=t,e[24]=c):c=e[24],g=c}return g}function v(f,e,l,b){if(l==="raw")throw new Error("turboChargeResultIfSourceMap does not support raw perspective");return J(e,b,r=>{if(!r._projectId&&(f!=null&&f._id)&&N(f._id)===N(r._id))return f},(r,{previousValue:i})=>typeof r=="number"&&typeof i=="string"?`${r}`:r,l)}function _(f,e){return`${f}-${typeof e=="string"?e:JSON.stringify(e)}`}export{ae as default,v as turboChargeResultIfSourceMap};
